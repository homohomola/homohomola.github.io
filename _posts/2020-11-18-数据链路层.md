---
layout:     post
title:      数据链路层
subtitle:   TCP/IP第2层
date:       2020-11-18
author:     sakura
header-img: img/the-first.png
catalog: true
tags:
    - 计算机网络
---

# 3 数据链路层

## 3.1 数据链路层概述



### 3.1.1 数据链路层功能

- 为网络层提供服务（无确认的无连接服务，有确认的无连接，有确认的有连接服务）

- **链路管理**：负责数据链路的建立、维持和释放，主要用于面向连接的服务
- **帧同步**：接收方确认收到比特流中一帧的起始与结束位置
- 流量控制（限制发送方）——点对点
- 差错控制（帧出错）



### 3.1.2 数据链路和帧

- 链路(link)    从一个节点到相邻节点的一段物理链路(有线或无线)，中间没有其他交换节点——物理通道
-  数据链路(data link)    把实现通信协议的硬件和软件加到链路上，形成数据链路——逻辑通道
- 数据（逻辑链路）= 物理链路 + 协议
- 数据链路层的协议数据单元——帧，以帧为单位传输处理数据

### 3.1.3 数据链路层的三个基本问题

- 封装成帧
- 透明传输
- 差错检测



#### **1. 封装成帧**

> 数据链路层给上层交付的协议数据单元添加帧头和帧尾，使之成为帧

- 帧头和帧尾包含重要的控制信息
- 帧首部和尾部作用之一就是确定界限(帧定界)
- 帧定界符——SOH(Start Of Header)     EOT(End Of Transmission)

#### **2. 透明传输**+

> 无论什么样的比特组成的数据，都能按照原样没有差错地通过数据链路层

组帧方式

- 字符计数法
    - 用一个特殊的字符来表示一帧的开始，用一个计数字段表明该帧包含的字节数(包括计数字段)，很少使用

- **字节(符)填充**的首尾界符法(面向字节的物理链路)
    - 首尾界符SOH、EOT
    - 当数据部分出现SOH,EOT,ESC时，填充一个ESC
    - 特例：MAC帧不需要帧结束符和填充，以太网传输帧时，各帧之间有一定的间隙
- **比特填充**的首尾标志法(面向比特的物理链路)
    - 比特填充首尾界符为 01111110
    - 对数据部分出现5个连续的1，填充一个0(零比特传输)
- 物理编码违例法
    - 利用物理介质编码的违法标志区分帧的开始与结束
    - 列如，曼特斯特编码的高-高，低-低电平，可作为首尾标志

#### 3. 差错控制

**比特差错**： 实际通信链路不理想，传输可能产生差错，信噪比越高，失真越小，差错率越小

**误码率BER**(Bit Error Rate)：一段时间内，传输错误比特所占比率

**概念：凡是接收端数据链路层接受的帧均无差错**



##### 3.1 检错编码++

通过一定的编码和解码，在接收端解码时检查出传输的错误，但不能纠错

- 奇偶校验码
    - 在信息码后添加一位校验码，分**<u>奇校验</u>**和**<u>偶校验</u>**
    - 奇校验：添加校验位，使1的个数位奇数
    - 偶校验：添加校验位，使1的个数为偶数
    - 漏检率高，计网不采用
- **循环校验码**CRC(Cyclic Redundancy Check)
    -  约定一个**生成多项式G(X)**  n+1次，在数据后补n位0
    - 使用数据除生成多项式G(X),求得余数R，拼接在数据后
    - 接受方将收到数据帧除以多项式G(X)——模2运算，得到余数不为0，则表示出错，将其丢弃
    - 这种为了检错而被添加的冗余码被称为**帧检验序列FCS**(Frame Check Sequnence)
    - 特性：
        - r为检测位能检出所有小于等于r的突发错误
        - 长度大于r + 1 的错误逃脱概率是 1/(2^r)
        - CRC仅能实现无差错接受，不能做到可靠传输（虽然具有纠错功能，但在计网中一般不使用）
        - 数据链路层，FCS和CRC校验都是硬件完成，不会延误数据传输

##### 3.2 纠错编码

**海明码**

- 编码
    - k位信息位
    - r位校验码
    - $2^r\ge k+r$
    - 校验码位置在$2^{i-1}$处
    - 校验位求值
        - 设出错为$e_4e_3e_2e_1$,海明码第一位就是0001，第三位为0011，可得
        - $e_1=M_1 \oplus M_3 \oplus M_5 \oplus M_7 \oplus M_9$
        - $e_2 =M_2 \oplus M_3 \oplus M_6 \oplus M_7 \oplus M_10$
        - $e_3=M_4  \oplus M_5 \oplus M_6 \oplus M_7$
        - $e_4=M_8 \oplus M_9 \oplus M_10$
        - $e^4e^3e^2e^1$全为0，解答校验位数值
- 校验
    - 带入数据，解得出错为数值，转化为10进制，得到错误位置
    - 海明码要检测d位错误，需要码距为 d+1 的编码方式，纠正d为错误，需要码距 2d +1 的编码方式
    - L - 1 = D + C      且$D \ge C$
    - L为码距，D为检测d位错，C为纠正c位错

## 3.2 可靠传输++

传输差错类型：分组丢失、分组乱序、分组重复、比特差错

数据链路层向上层提供服务类型

- **不可靠传输服务**    丢弃误码帧
- 可靠传输服务    实现发送方发什么，接受方收到什么

- 有线链路误码率低，不要求向上层提供可靠传输服务
    - 以太网不要求数据链路层提供可靠传输
- 无线链路易受干扰，要求数据链路向上层提供可靠传输服务
    - 802.11无线局域网要求数据链路层实现可靠传输



### 3.2.1 滑动窗口机制

- 只有接受窗口向前滑动(同时发送确认)，接受窗口才有可能向前滑动，实现流量控制，控制发送方发送速率，使得接收方来得及接收
    - 停止-等待协议：发送窗口=1，接受窗口=1
    - 后退N帧协议：发送 >1 , 接受窗口 = 1
    - 选择重传协议：发送 >1 , 接受窗口 > 1
- 接收到的数据在窗口之外的，一律丢弃

### 3.2.2 停止-等待协议SW

 ![image-20201005132704979](https://gitee.com/happy_every/note_pic/raw/master/image-20201005132704979.png)

- 使用**确认**和**超时重传**机制

    - 为了接受方能够判断收到的数据分组是否是重复的，需要给数据分组编号
    - 为了发送方能够判断接收到的ACK分组是否是重复的，需要给ACK分组编号。对于点对点协议PPP，数据分组一般不会出现迟到，所以数据链路层实现 SW 可以不用给ACK分组编号
    - 使用确认和重传机制实现可靠传输的策略被称为自动请求重传ARQ(Automatic Repeat reQuest)

- 信道利用率

    - ![image-20201005134643972](https://gitee.com/happy_every/note_pic/raw/master/image-20201005134643972.png)

    - 信道利用率 $ U = \frac{T_D}{T_D +RTT + T_A} $



### 3.2.3 回退N帧协议GBN

- 发送窗口大小取值 $W_T$ : $ 1< W_T  \le 2^n-1$     ，n为分组编号的比特数(3个比特，分组0-7，n = 3)——防止接受方无法分辨新、旧分组(因确认分组丢失、导致发送方重发分组)
- 接受窗口大小：$W_R=1$
- 原理：
    - 发送方可以连续发送多个数据帧，收到确认后接着发送
    - 接受方对按序到达的最后一个数据分组发送确认，ACKn表示序号n及之前的分组已经正确接收
- 优点：减小接收方开销、信道吞吐量
- 缺点：帧出错时，接受方简单丢弃了该帧及后续帧，发送方超时后需重发该帧后的所有帧，造成浪费
- 是滑动窗口协议、连续ARQ协议，当通信线路质量不好时，信道利用率不比SW高



### 3.2.4 选择重传协议SR

- 发送窗口尺寸 $W_T \le 2^{n-1} $,防止新旧数据重叠，一般$W_T=W_R$,达到最大效率
- 接受出错帧后面的帧，存入缓冲区，要求发送方重发出错的帧
- 接收方采用逐一确认，而不是累计确认

- 提高信道利用率，但增加了接收方的缓冲空间



## 3.3 点对点协议PPP

**PPP协议**(Point to Point Protocol)就是用户计算机和 ISP 通信时所使用的协议。同时也应用于广域网WAN路由器之间的专用线路

### **3.3.1 PPP协议构成**

- 对各种协议数据报PDU的封装方法（封装成帧）
- 链路控制协议LCP    用于建立、配置测试数据链路的连接，能在多种类型的点对点链路上运行，例如面向字节的异步电路、面向比特的同步电路
- 一套网络控制协议NCPs    其中每一个协议支持不同的网络层协议



### **3.3.2 帧格式**

![image-20201005145152145](https://gitee.com/happy_every/note_pic/raw/master/image-20201005145152145.png)

标志(Flag)：PPP帧的定界符，取值0x7E（01111110）

地址(Address)：取值0xFF，预留

控制(Control)：取值0x03，预留

协议(Protocol)：指明帧的数据部分送交哪个协议处理

​	0x0021—IP数据报	0xC021—LCP分组	0x8021—NCP分组

帧检验序列 FCS 采用 CRC 循环校验码

### **3.3.3 透明传输实现**

- 对于面向字节的异步链路采用**字节填充**
    - 对于0x7E（标志符）和0x7D（转义字符ESC），在前面加上0x7D（ESC），并减去0x20
    - 对于ASCII码的控制字符(小于0x20的字符)，在前面加上0x7D（ESC)，并加上0x20（偏移量），保证不再是控制字符
- 对于面向比特的同步电路采用**零比特传输**
    - 在SONET/SDH链路上，对连续5个1，填充一个0

### 3.3.4 PPP帧应满足的需求

1.**简单**	数据链路层没有必要提供比IP协议更多的功能，对于帧不需要纠错、序号、流量控制

2.**多种网络协议**	支持同一链路上的多种网络层协议

3.**多种类型链路**	串行并行，同步异步，低、高速，光或电，交换、非交换的点对点链路.例如，PPPoE 为宽带上网的链路层协议。将PPP帧封装在以太帧中

4.**检测连接状态**	及时自动检测链路是否处于正常工作

5.**网络层地址协商**	使两个网络层之间能 配置或知道 彼此的网络层地址（连接ISP，分配IP地址）

6.**数据压缩协商**	协商使用数据压缩算法，不要求标准化

- 不支持多点线路(一对多轮流通信)，只支持**点对点**链路通信和**全双工**通信

### 3.3.5 工作状态

![image-20201005183424987](https://gitee.com/happy_every/note_pic/raw/master/image-20201005183424987.png)

1. 用户拨号接入ISP，路由器的调制解调器对拨号进行确认，建立物理链路

2. LCP开始协商一些配置选项，即发送LCP的配置请求帧，这是一个PPP帧，信息字段包含特定的配置请求。链路另一端发送响应:

- 配置确认帧	所有选项都接受
- 配置否认帧    所有选项都理解但不能接受
- 配置拒绝帧    选项有的无法识别或不能接受，需要协商
- LCP配置包括最大帧长、所使用的**鉴别协议**

3. 协商结束后双方建立LCP链路，进入**鉴别**状态，此状态下，只允许发送LCP协议分组、鉴别协议的分组和监测链路质量的分组。鉴别失败，转到**链路终止**，成功，则进入**网路层协议**状态
    - 口令鉴别协议PAP
    - 口令握手鉴别协议CHAP
4. 在**网络层协议状态**下，PPP链路两端的网络控制协议NCP根据网络层的不同协议交换网络层特定的网络控制分组
    - PPP链路上运行IP协议时，对PPP链路每一端配置IP协议模块(如分配IP地址)时就要使用NCP中支持IP的协议——IP控制协议IPCP(IP Control Protocol),IPCP分组也封装成PPP帧
5. 网络层配置完毕后，链路进入**链路打开**状态，可以通信，还可发送**回送请求LCP**分组和**回送回答LCP**分组，检查链路状态。
6. 传输结束后，链路一端发送**终止请求LCP**分组，接收到对方发来的**确认终止LCP**分组后，转到链路终止状态。当调制解调器载波终止后，回到**链路静止**状态

### extra HDLC协议

特点：

- 高级数据链路控制HDLC协议是ISO制定面向比特的数据链路控制协议
- 可靠传输、对信息帧使用编号和确认机制
- 适用于链路的两种基本配置
    - 非平衡配置：一个主站控制整个链路
    - 平衡配置：两端的两个站都是复合站，可以平等发起数据传输，不需要对方同意
- 帧格式
    - PPP帧比HDLC帧多一个2字节的协议字段
    - 地址字段
        - 非平衡模式下：为次站地址
        - 平衡模式下：全1为广播，全零为无效地址
    - 控制字段（分三类）
        - **信息帧**    传输字段或使用捎带技术确认和应答
        - **监督帧**    流量检测和差错控制，执行对帧的确认、请求重发、暂停等功能
        - **无编号帧**    提供链路建立、拆除及多种控制功能

## 3.4 介质访问控制MAC

**共享信道要着重考虑的问题就是如何协调多个发送和接受站点对一个共享传输媒体的占用，即<u>介质访问控制MAC</u>(Medium Acess Contorl)**

### 3.4.1 局域网LAN的数据链路层

广播信道可以实现一对多的通信，基于广播信道的局域网

**局域网特点**

- 具有广播功能，局域网上的主机可共享局域网上的软硬件资源
- 便于系统的扩展和逐渐演变
- 提高网络系统的可靠性、可用性、生存性

**网络拓扑**

- 星型	使用集线器

- 环型

- 树形

- 总线网

    - ![image-20201006082340003](https://gitee.com/happy_every/note_pic/raw/master/image-20201006082340003.png)

    - 总线网两端为匹配电阻（吸收电磁波信号的能量）
    - 总线网在局域网中性能最优

### 3.4.2 静态划分信道

预先固定分配好信道，不灵活（对于突发性数据传输），在无线网络物理层使用（不适合局域网使用）

#### Extra：复用和多址的区别

> **复用技术和多址技术最大的区别在于应用的领域不同**
>
> **复用**这个词通常用在传输上，将一个物理信道根据时间、频率、空间等资源划分为多个虚拟信道。这么做的好处有二：一是减少管道的个数，为运营商减少线路成本；二是提升单通道的容量。从作用上看都是针对传输而言的，与具体用户无关。
>
> **多址**（多点接入）则应用在接入中，**用户只暂时的占用信道**。同一个基站下，不同的用户利用相同的资源（同一时间，同一频率）发出通信请求肯定会发生冲突。而多址技术正是用来解决这个问题：如何划分资源块，使更多的用户终端能够在不发生冲突的情况下获得服务。

#### 1. 频分多路复用FDM

![频分复用FDM示意图](https://gitee.com/happy_every/note_pic/raw/master/image-20201006092159512.png)

**频分复用的所有用户占用不同的频带资源进行通信**

为防止子信道之间干扰，相邻信道间加入隔离信道

#### 2. 时分多路复用TDM

**同步时分复用**

![时分复用TDM示意图](https://gitee.com/happy_every/note_pic/raw/master/image-20201006092613428.png)

时分复用将时间划分为一段段等长的时分复用帧，每一用户占用固定序号的时隙，并周期性出现。

**时分复用是所有用户在不同时间占用同样的频带宽度**

空闲状态下，信道利用率低



**统计时分复用STDM**（Statistic TDM）

动态时间分配，按需动态分配时隙，又称**异步时分复用**

STDM帧中每个时序还必须有用户地址信息，增加了开销，提高了对报文的存储转发能力

#### 3. 波分多路复用WDM

对光的频分复用，使用合波器和分波器，中间链路使用掺铒光纤放大器EDFA放大光信号

#### 4. 码分多路复用CDM

又称码分多址CDMA

- CMD用户可以通过使用**不同码型**，在同时间同频带通信，抗干扰能力强。挑选原则：
    - 每个站的码片序列**不同**且**相互正交**(规格化内积为0)，实际使用**伪随机码序列**
    - 任意码片序列与自身规格化内积为1，与自身反码向量规格化内积为0

- 在CDMA中，每个比特时间再划分为m个短的间隙，称为**码片**（Chip），通常m的值为64或128
- 每个使用CDMA的站被指派唯一的m bit 码片序列(Chip Sequence)
    - 发送比特1，则发送m bit码片序列
    - 发送比特0，则发送m bit码片序列反码
    - 为变表示方便，码片序列 0 记作 - 1 ，1 记作 + 1
- 因为实际每个比特要转换成m个比特序列，实际数据发送率提高m倍，所占用的频带宽度也提高m倍。这种通信方式是扩频通信的直接序列扩频DSSS，另一种是调频扩频LHSS
- **计算方法**
    - 用收到的码片序列与各站码片序列求内积，数值为1/-1，则发送比特1/0；为0，说明未发送

### 3.4.3 动态媒体接入控制

#### 1. 受控接入

- **集中控制**	有一个主站以循环询问每个站点有无数据发送，只有被轮询到的站点才能发送数据，缺点是存在单点故障问题
- **分散控制**    各站点是平等的，连接成环形网络。令牌沿环逐站传递，接收到令牌的站点才能发送数据，发送完后传递令牌给下一个站点

#### 2. 随机接入

所有站点通过竞争，随机地在信道上发送数据，但恰有两个或更多用户一同发送数据，在共享媒体上就会发生碰撞，使得发送失败。因此必须有解决碰撞的网络协议

##### 2.1 ALOHA协议

**纯ALOHA协议**：当网络中任何一个结点需要发送数据时，可以不进行检测就发送，如果一段时间内没有收到确认，就认为发送冲突，需等待一段随机时间后再发送，直到成功发送。协议简单，但信道利用率低

**时分ALOHA协议**：所有结点的时间被划分为间隔相同的时隙(Slot)，并规定只有等到下一个时隙到来才能发送数据

##### 2.2 CSMA协议

​	载波监听多址接入协议是在ALOHA协议基础上改进的多路访问控制协议.在CSMA策略：

- 1-坚持CSMA：当监听到信道空闲时，立即发送数据，否则继续监听
- p-坚持CSMA：当监听到空闲，以概率p发送数据，(1-p)概率延迟一段时间并重新监听
- 非坚持CSMA：监听到空闲，发送数据，否则延迟一段随机时间并重新监听

即使造成冲突，CSMA也要将已破坏的帧发送完，信道利用率低

##### 2.3 CSMA/CD协议

载波监听多点接入/碰撞检测 协议，用于**总线型半双工局域网**

在发送过程中继续监听信道。如果发送冲突，信道上可以检测到超过自身发送载波信号的幅度，由此判断冲突存在，并立即停止发送

发送帧的站点还要发送32或64bit的人为干扰信号，使所有站点都能检测到碰撞

**电磁波在1km电缆传播时延约为5μs**

**争用期（碰撞窗口）**

![image-20201006123757302](https://gitee.com/happy_every/note_pic/raw/master/image-20201006123757302.png)

- 以太网的端到端往返传播时延2t称为争用期，51.2μs
- 经过争用期这段时间还没检测到碰撞，才能肯定这次发送不会发生碰撞
- 以太网网中主机越多，端到端往返传播时延越大，发生碰撞的概率就越大。因此，共享式以太网不能连接太多主机，使用总线也不能太长

**最小帧长**

- 设置最小帧长区分噪声和发生碰撞的短帧
- 最小帧长 = 总线传播时延 * 2 * 数据传输速率
- 最小帧长与最远两个站的距离和传输速率成正比
- 以太网规定最小帧长为64字节（512比特时间即为争用期）
- 对于数据量少的帧，可以填充字节

**最大帧长**

以太网规定数据部分为1500字节



**截断二进制数退避算法**

退避时间 = 基本退避时间 * 随机数 r

基本退避时间=争用期2t

r={0，1，……，（$2^k$-1）} 中随机的数，k = Min{重传次数N，10}

当N=16时，丢弃帧，并向上层报告

> **截断二进制数退避算法**可使重传需要推迟的平均时间逐渐增加（动态退避），可能导致一方重传时间越来越长，一方却在连续发送，这称为**捕获效应**

**信道利用率**

![CSMA/CD信道利用率](https://gitee.com/happy_every/note_pic/raw/master/image-20201006130241889.png)

理想情况：

- 发送一帧占用时间为$T_0+t$ ,帧本身发送时间为$T_0$
- 极限信道利用率$S_{MAX}=\frac{T_0}{T_0+t}$
- 以太网端到端的距离应受限，帧的长度应尽量大



**发送流程**

- 准备数据
- 监听信道，到信道空闲时间达到9.6μs（96比特时间为**帧间最小间隔时间**）时，发送帧
- 发送过程中，不断检测信道

**接受流程**

- 判断帧长
- 检验MAC地址是否相同
- 使用CRC校验

**现状**

曾用于各种总线结构以太网和双绞线以太网早期版本中。现在以太网基于交换机和全双工连接，不会有碰撞



##### 2.4 CSMA/CA协议

载波监听多点接入/碰撞避免 协议

不能使用碰撞检测CD：

- 无线网传输条件特殊，信号强度动态范围大，对硬件要求高
- 存在隐蔽站问题（单点检测距离有限）

**802.11无线局域网使用数据链路层确认机制SW协议，**来保证数据正确接受。因为无线链路误码率高，所以**在链路层实现可靠传输**

**帧间间隔**IFS

- 所有站点必须检测到一段空闲时间才能发送帧
- 长短取决于帧的类型(高优先级优先发送)
    - 短帧间间隔SIFS(28μs)    用来分别隔开属于一次对话的各帧
    - DCF帧间间隔DIFS(128μs)

![image-20201006140809734](https://gitee.com/happy_every/note_pic/raw/master/image-20201006140809734.png)

- 退避算法使用情况
    - 发送前检测到信道忙
    - 重传数据帧
    - 发送成功后的连续发送的下一个帧（避免长时间占用）
- 执行退避算法时，站点为退避计时器设置随机退避时间
    - 时间到零，就发送
    - 当转变到信道忙时，就冻结时间。信道空闲重新后，进过DIFS后，继续重启计时器
    - 第 i 次退避，退避时间 =时序编号{0，1……$2^{i+1}-1$} *基本退避时间(一个时隙), 时序编号最大255（对应第6次退避）

![image-20201006141729270](https://gitee.com/happy_every/note_pic/raw/master/image-20201006141729270.png)



**CSMA/CA协议的信道预约**和虚拟载波监听

- 发送RTS帧对信道预约,站点回应CTS帧（都携带通信持续时间）
- 其他站收到CTS帧后，就推迟接入局域网![image-20201006142856503](https://gitee.com/happy_every/note_pic/raw/master/image-20201006142856503.png)

- 除RTS、CTS数据, 数据帧也能携带通信持续时间，这称为802.11的**虚拟载波监听**机制
- 由于虚拟载波监听机制，只要RTS、CTS、数据帧中的一个，就能知道信道被占用时间，而不需要真正监听信道上的信号，减小隐蔽站带来的碰撞问题

![image-20201006143514981](https://gitee.com/happy_every/note_pic/raw/master/image-20201006143514981.png)





## 3.5 MAC地址、IP地址、ARP地址

### 3.5.1 MAC地址

​	使用点对点信道的数据链路层不需要使用地址。使用广播信道的数据链路层必须使用地址区分主机。

每个主机发送的**帧中必须包含标识主机和接收主机的MAC地址**

- MAC地址被固化在网卡（网络适配器）的EEPROM中
    - 适配器就是嵌入式网卡,适配器实现
        - 串行传输和并行传输的转换
        - 对数据进行缓存
        - 能够实现以太网协议（如CSMA/CD)
    - 适配器包含物理层和数据链路层的功能

- MAC也被称为**物理地址**，但**<u>MAC并不属于物理层</u>**

- **MAC地址是对网络各接口的唯一标示，而不是对设备的标识**，也就是说，一个设备多个接口就有多个MAC地址

- MAC地址格式（EUI-48)

    ![image-20201006181014354](https://gitee.com/happy_every/note_pic/raw/master/image-20201006181014354.png)

    转换为16进制进行表示

    - $b_1$：0 表示 全球管理
    - $b_1$：1 表示 本地管理
    - $b_0$:    0 表示 单播
    - $b_0$:    1 表示 多播

    ![image-20201006181530226](https://gitee.com/happy_every/note_pic/raw/master/image-20201006181530226.png)

    - 字节发送顺序：第一字节到第六字节
    - 字节内比特发送顺序：$b_0->b_7$

- 单播MAC地址

    - 帧首部为目标地址+源地址

- 广播MAC地址

    - 帧首部为广播地址(FF-FF-FF-FF-FF-FF)+原地址

- 多播MAC地址

    - MAC帧第一个字节的最低位为1($b_0=1$)
    - 接受主机根据自身多播组列表判断是否丢弃

- 随机MAC地址

    - 目前许多设备win10和安卓都已采用

### 3.5.2 IP地址

IP地址是互联网上主机和路由器所使用的地址，用于标识信息

- 网络编号：标识互联网上的网络
- 主机地址：标识同一网络上不同主机（或路由器各接口）
- MAC地址具备区分不同网络的功能
- 传输过程中数据首部IP目的地址和源地址不变
- 目的和源MAC地址逐个链路或网络改变

### 3.5.3 ARP协议

**通过IP地址找到对应的MAC地址**，地址解析协议ARP

1. 每台主机都有ARP高速缓冲，记录IP地址和对应MAC地址。

2. 发送帧前，需查表寻找目的MAC地址，如无则广播发送ARP请求报文，请求对应IP地址的MAC地址。

3. 目的主机发送ARP响应帧，源主机收到后，将地址写入缓存中。
4. 高速缓存内类型分为动静态，动态为自动获取，生命周期默认两分钟，静态为手动设置，生命周期不同

**ARP协议是逐段链路使用的**



## 3.6 以太网

**历史**	IEE 802.3标准定义的局域网参考模型对应OSI参考模型中的数据链路层和物理层，并将数据链路层拆分成：逻辑链路控制LLC子层和媒体接入控制MAC子层。与传输媒体有关的内容都放在MAC子层。但由于以太网的垄断地位，DIX Ethernet V2标准被广泛应用，因此LLC子层不在需要考虑。

**以太网采用总线拓扑**

- 采用无连接，提供不可靠服务，但有重传机制
- 不对数据帧编号、无需确认

### 3.6.1 以太网的MAC帧

![image-20201006190805302](https://gitee.com/happy_every/note_pic/raw/master/image-20201006190805302.png)

![image-20201006190817775](https://gitee.com/happy_every/note_pic/raw/master/image-20201006190817775.png)

以太网v2 MAC帧不需要帧结束符，以太网传输帧时，各帧间有一定时隙

### 3.6.2 以太网的传输介质

|   标准   |  电缆  | 每段最大长度/m | 每段最大节点数 |
| :------: | :----: | :------------: | :------------: |
| 10Base5  | 粗电缆 |      500       |      100       |
| 10Base2  | 细电缆 |      185       |       30       |
| 10Base-T | 双绞线 |      100       |      1024      |
| 10Base-F |  光纤  |      2000      |      1024      |

BASE指信号为**基带信号**，采用曼特斯特编码

10表示数据传输速率为10Mbit/s

5、2表示电缆长度最大为500、200米（实为185），

T(双绞线)，F(光纤)

### 3.6.3 高速以太网

- 100Base-T以太网（快速以太网）
    - 提高数据传输率，100Base-T保持最小帧长不变，减小最大电缆距离和帧间间隔
- 吉比特以太网（千兆以太网）
    - 提高数据传输率，采用载波延伸。
    - 最短帧长仍为64B，争用期增大为512B，小于512B，就填充。
    - 为避免太大浪费，有分组突发功能
- 10吉比特以太网
    - 只使用光纤传输
    - 只工作在全双工模式下

### 3.6.4 无线局域网

IEEE 802.11是无线局域网的标准协议，包括802.11a和802.11b等

1. 无线局域网的组成

    无线局域网可分为两大类：有/无 固定基础设施

    - 有固定基础设施无线局域网
        - 最小构建为基本服务集BSS
        - BSS包括一个基站和若干个移动站
        - 站内可直接通信，和站外通信需进过基站（也称接入点AP)
        - BBS可以通过AP连接到主干分配系统DS，再接入另一个BBS，构成ESS
        - ESS通过门桥(Portal)设备，为无限用户接入到非802.11局域网(如有线因特网)

    - 无固定基础设施
        - 平等状态的移动站组成的临时网络，移动站具有路由器功能

2. 无线局域网802.11中的物理层

    - 调频扩频FHSS
    - 直接序列扩频DSS
    - 红外线HR

3. 无线局域网802.11中MAC层

    - MAC层在物理层上，包含两个子层，点协调功能PCF子层和分布协调DCF子层（下层）
    - 使用CSMA/CA协议，同时增加确认机制

### 3.6.5 令牌环网

IEEE 802.5标准在Token Ring协议基础上发展和形成

**令牌是特殊MAC控制帧，帧中有一位来标志令牌(忙/闲)**

**传递过程：**

- 令牌传递到要发送数据结点，结点修改令牌中的标志位，并附加传输数据，令牌变成数据帧
- 接收结点复制该帧，令牌继续传输
- 源结点收到令牌，可以校验数据帧是否出错，进行重传
- 发送完数据后，重新生成令牌，传递给下个站点，交出权限

## 3.7 以太网扩展

### 3.7.1 物理层扩展以太网

- 早期总线以太网使用细同轴电缆，用转发器扩展以太网的地理覆盖范围。现在使用光纤和一对光纤调制解调器
- 使用双绞线和集线器HUB的星型以太网
    - 物理上是星型，逻辑上还是总线网络，使用CSMA/CD协议
    - 集线器只工作在物理层，简单转发
    - 有少量容错能力和网络管理功能
    - 使用RJ-45插头（水晶头）的双绞线，
- 使用多个集线器就能形成多级星型结构的以太网
    - 冲突域变大，数据吞吐量变小
    - 以太网技术不同就不能互连

### 3.7.2 链路层扩展以太网

#### 1. 网桥

网桥特点：具有过滤帧的功能。

网桥至少有两个端口，每个端口与一个网段相连，每接收到一个帧，就暂存到缓存中（存储转发）。若发送另一个网段则查表转发

优点：

- 提高通信量、扩大物理范围
- 提高可靠性，可互连不同物理层、MAC子层、不同速率的以太网

缺点：

- 存储转发增加了时延
- MAC层没有流量控制
- 对于不同MAC子层互连后，时延更大
- 只适合用户数几百和通信量不大的局域网



##### 1.1  透明网桥

**透明网桥自学习算法**

- 网桥收到帧后新进行自学习。
- 查表，没有则添加项目（源地址、进入的接口、时间）
- 转发帧。查不到则广播帧；若查表得到帧的接口是进入接口则丢弃



##### **1.2 源选径网桥**

​	路由选择由发送数据帧的源站负责，网桥只根据数据帧中的路由信息对帧接收和转发

​	原站以广播方式发送一个帧，帧沿所有可能路由传输并记录所有经过的路由。到达目的站后，再沿原路径返回。源站再选择**最佳路由**

​	最佳路径并不一定是经过路由器最少的路径，也可以是发送帧往返时间最短的路径

#### 2. 局域网交换机

交换机实质上是多端口网桥，以全双工方式工作。**不会发生冲突，不需要CSMA/CD协议**

以太网交换机全双工模式下总容量为 2 * N * 端口到主机的带宽（N为端口数）

**优点：**

- 将冲突域隔离开来
- 交换机总带宽随端口增加而增加

**两种交换模式：**

- 直通式交换（基于硬件的交叉矩阵）
    - 只检查目的地址
    - 速度开、安全性低、不支持不同速率端口交换
- 存储转发式交换
    - 存储在高速缓存中、延迟较大
    - 可靠性高、支持不同速率端口

**工作流程**（自学习算法）

- 接收帧，并**登记**（记录MAC地址与接口地址）
- 查表，如查不到目的地址记录则广播帧；查到记录则明确转发
- 遇到若查表得到帧的接口是进入接口则丢弃
- 每条记录有**有效时间**，到期删除（MAC地址与接口地址对应关系不是永久的）

**生成树协议STP**

添加**冗余链路**提高以太网可靠性

冗余链路会形成**网络环路**

网络环路带来问题：

- 广播风暴：大量消耗网络资源，广播帧不断循环发送
- 主机收到重复广播帧
- 交换机的帧交换表震荡（在接口错误记录中反复漂移）

**STP概念：**

- 交换机自动计算并构建一个逻辑上没有环路的网络，逻辑拓扑结构为树型
- 最终生成树型逻辑拓扑需连通整个网络
- 首次连接或网络物理拓扑变化时，交换机都进行生成树的重新计算

## 3.8 虚拟局域网VLAN

交换机扩大了以太网的广播域（一个局域网就是一个广播域）

巨大的广播域的弊端：

- 广播风暴
- 难以维护和管理
- 潜在的安全问题

**分割广播域的方法**

- 使用路由器隔离广播域（默认情况下不对广播进行转发，因为每个端口是不同网络）
- 虚拟局域网    将局域网内主机逻辑分组(同一组才可通信广播)

**VLAN实现**

1. 交换机能处理带有VLAN标记的 IEEE 802.1Q帧（Dot One Q帧）![image-20201007110237214](https://gitee.com/happy_every/note_pic/raw/master/image-20201007110237214.png)
    - VLAN标记最后12比特为VLAN标识符VID
    - VID取值为1~4094（ 1 ~~ $2^{12}-1$)
        - 802.1Q帧由交换机处理
            - 收到普通以太网帧，插入4字节VLAN标记
            - 转发802.1Q帧时，可能删除VLAN标记转变为普通帧
2. 交换机各端口支持不同的端口类型

- 交换机端口类型
    - Access
        - 用于用户计算机、只能属于一个VLAN
        - 端口 ID =VLAN ID （虚拟局域网序号）
        - 只接收无标签MAC帧，如果帧的VID与自生VID相同则去标签转发
        - ![image-20201007111533490](https://gitee.com/happy_every/note_pic/raw/master/image-20201007111533490.png)
    - Trunk
        - 用于交换机间或交换机与路由器互连
        - 可属于多个VLAN
        - 如果帧VID与自身相同，去标签转发；不同，直接转发。
        - 接收到无标签帧，就打标签
        - 互连的trunk应相等，否则会产生错误
        - ![image-20201007111849556](https://gitee.com/happy_every/note_pic/raw/master/image-20201007111849556.png)
    - Hybrid
        - 发送处理方法不同
        - 设置去标签列表(白名单，不在白名单内接收带标签帧)
            - 查看帧VID是否在端口去标签列表中
            - 存在，去标签转发；不存在，直接转发
- 交换机个端口缺省VLAN ID
    - 每个端口仅有一个VLAN ID