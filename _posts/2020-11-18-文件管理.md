---
layout:     post
title:      OS文件管理
subtitle:   文件管理方式
date:       2020-11-18
author:     sakura
header-img: img/the-first.png
catalog: true
tags:
    - 操作系统

---

## 4.1 文件系统基础

### 1. 文件的概念

#### 1.1 文件的定义

文件就是一组由意义的信息/数据的集合

#### 1.2 文件的属性

**文件名**：由创建文件的用户决定，**同一目录不允许有重名文件**

**标识符**：各文件的标识符唯一，是OS用于区分各文件的内部名称

**类型**：指明文件的类型

**位置**：文件存放的路径(用户)，在外存的地址(OS使用)

**大小**：文件大小

**创建时间、上次修改时间、文件信息所有者**

**保护信息**：对文件进程保护的访问控制信息

#### 1.3 文件的基本操作

##### 1.  创建文件(create系统调用)

进行create系统调用时，需要提供的参数

- 所需外存空间
- 文件存放路径
- 文件名

OS接受请求后，**在外存中找到文件所需的空间**，根据路径信息找到目录对应目录文件，在目录中**创建该文件对应的目录项**

##### 2. 删除文件(delete)

参数：文件路径、文件名

OS根据路径找到目录项，根据目录项记录的文件在外存中的位置，回收文件占用的磁盘块，从目录项中删除文件对应的目录项

##### 3. 打开文件(open)

参数：路径、文件名、操作类型

OS根据路径找到目录文件，从中找到文件名对应的**目录项**，检查用户的操作权限

将目录项**复制到内存中的打开文件表**，并返回对应表目的编号，之后用户使用打开文件表的**编号**(**索引号**，也称**文件描述符**)指明要操作的文件

打开文件后，对文件的操作不需要每次都查询目录，可以根据内存中的打开文件表进行操作

open返回指向文件表中对应目录的指针，简化步骤

![image-20201102230105308](https://gitee.com/happy_every/note_pic/raw/master/image-20201102230105308.png)

系统的打开文件表

![image-20201102230332888](https://gitee.com/happy_every/note_pic/raw/master/image-20201102230332888.png)



##### 4. 关闭文件(close)

将进程的打开文件表相应表项删除

回收分配给该文件的内存资源空间

系统打开文件表的打开计数器count减1，若count=0，则删除对应表项

##### 5. 读文件(read)

根据读指针、读入数据量、内存位置 将文件数据从外存读入内存

##### 6. 写文件(write)

根据写指针、写出数据量、内存位置 将文件数据从内存写回外存

### 2. 文件的逻辑结构

#### 2.1 无结构文件

文件内部数据就是一系列二进制流或字符流组成，又称**流文件**，如txt文件

#### 2.2 有结构文件

一组相似的记录组成，又称**记录式文件**，每条记录由若干个数据项组成，每条记录有一个数据项作为**关键字**

根据各条记录的长度，可分为**定长记录**和**可变长记录**



有结构文件按记录的**逻辑组织**可分为三类

##### 1. 顺序文件

文件的记录一个接一个顺序排列(逻辑上)，记录可以是定长或变长的，记录在物理上可以是**顺序存储或链式存储**

- 串结构：记录间的顺序与关键字无关，通常按记录存入的时间决定记录的顺序
- 顺序结构：记录按关键字排序

可变长记录的顺序结构文件无法实现顺序查找

定长记录的顺序结构的文件可以快速检索

缺点：不方便增删

##### 2. 索引文件

**实现可变长文件的随机查找**

对每个文件建立索引表项，索引表本身是**定长记录的顺序文件**

可以用不同的数据项建立多个索引表

##### 3. 索引顺序文件

不为每个记录对应一个索引表项，而是**一组记录对应一个索引表项**

索引顺序文件可以提升查找效率，可通过建立**多级索引表**进一步提高检索效率

##### 4. 散列文件

也称直接文件(hash file)，根据记录的key值或通过哈希函数转化的key值决定文件的物理地址

哈希文件有很高的存取速度，但会引起冲突



### 3. 文件目录

#### 3.1 文件控制块

目录本身就是一种有结构文件，由一条条记录组成，每条记录对应一个放在该目录下的文件

FCB的有序集合称为**文件目录**，一个FCB就是一个**文件目录项**

FCB包含了文件的基本信息（文件名、物理地址、逻辑结构、物理结构），存取控制信息、使用信息

**FCB实现了文件名和文件之间的映射**

目录操作：

搜索

创建文件：需要在其所属的目录中增加一个目录项

删除文件：需要在目录中删除对应目录项

显示文件

修改文件：某些文件属性变化时，修改相应的目录项



#### 3.2 目录结构

##### 1. 单级目录结构

早期操作系统不支持多级目录，整个系统中只建立一张目录表

![image-20201102142211659](https://gitee.com/happy_every/note_pic/raw/master/image-20201102142211659.png)

单级目录实现了按名存取，但不允许**文件重名**

##### 2. 两级目录结构

早期多用户操作系统，分为**主文件目录**和**用户文件目录**

![image-20201102142446560](https://gitee.com/happy_every/note_pic/raw/master/image-20201102142446560.png)

允许不同用户文件重名，可在目录上实现访问限制

##### 3. 多级目录结构

又称树形目录结构

从根目录出发的路径称为**绝对路径**，系统根据绝对路径一层一层地找到下一级目录，每往下一级就要进行一次I/O操作

为了提高效率，可以从使用**当前目录**出发的**相对路径**

树形目录结构**不便于实现文件的共享**

##### 4. 无环图目录结构

在树形目录结构的基础上，增加一些指向同一节点的有向边，使目录称为**有向无环图**，实现多个用户间的文件共享

![image-20201102143339532](https://gitee.com/happy_every/note_pic/raw/master/image-20201102143339532.png)

可以用不同的文件名指向同一个文件(目录)

需要为每个共享节点设置一个**共享计数器**，用于记录有多少地方在共享该节点，当用户提出删除节点的请求时，只是删除该用户的FCB、并使**共享计算器减1**，为0时再删除共享节点



#### 3.3 索引节点

**FCB的改进**，为了**提高检索的效率**，查找中只需用到文件名信息

使用索引节点机制，减少了I/O次数，因为一个内存块可以存放更多的FCB，CPU一次只读入一个内存块

![image-20201102144122371](https://gitee.com/happy_every/note_pic/raw/master/image-20201102144122371.png)

当找到文件名对应目录项时，才将索引节点调入内存，通过索引节点中记录的信息，就可以找到文件

存放在外存中的索引节点称为**磁盘索引节点**，内存中的称为**内存索引节点**

内存索引节点需要增加一些信息，如文件是否被修改、有几个进程访问该文件



### 4. 文件共享

#### 4.1 硬链接

**基于索引节点的共享方式**，索引节点是一种文件目录瘦身策略

![image-20201102231520335](https://gitee.com/happy_every/note_pic/raw/master/image-20201102231520335.png)



索引节点设置链接计数变量，表示链接到本节点的用户目录数



#### 4.2 软链接

**基于符号链的共享方式**，类似于Win下的快捷方式

索引节点指向的是Link型的文件，记录共享文件的存放路径

根据路径一层层查找目录，会有多次磁盘I/O，速度比硬链接慢



### 5. 文件保护

#### 5.1 口令保护

为文件设置一个口令，用户请求访问文件必须提供口令

口令一般存放在文件对应的FCB或索引节点中，OS会对比口令，正确则允许访问

**优点**：空间、时间开销小

**缺点**：口令在系统内部(FCB或索引节点中)，不够安全



#### 5.2 加密保护

使用**密码**对文件进行加密，在访问文件时需要提供正确的密码进行解密

外存中存储的是加密过的密文

**优点**：保密性强，不需要在系统中储存密码

**缺点**：编码/译码需要一定时间



#### 5.3 访问控制

在每个文件的FCB(或索引节点)中增加一个**访问控制列表**，记录各个用户可以执行哪些操作

![image-20201102234239925](https://gitee.com/happy_every/note_pic/raw/master/image-20201102234239925.png)

添加：将新信息添加到文件结尾部分

列表清单：列出文件名和文件属性

**精简的访问列表**：以组为单位，标记各组用户可以执行的操作类型

![image-20201102234523162](https://gitee.com/happy_every/note_pic/raw/master/image-20201102234523162.png)

**优点**：实现灵活，可以实现复杂的文件保护功能

## 4.2 文件系统实现

### 1. 文件系统层次结构

![image-20201103131310785](https://gitee.com/happy_every/note_pic/raw/master/image-20201103131310785.png)

#### 1. 用户调用接口

**为用户提供与文件及目录相关的调用**，此层由相关的模块组成(读写、打开等模块)，用户发出系统调用时，转入相应模块

#### 2. 文件目录接口

**管理文件目录**

#### 3. 存取控制验证模块

实现文件保护由该层软件完成，把用户访问要求与FCB中的访问控制权限进行比较

#### 4. 逻辑文件与文件信息缓冲区

根据文件的逻辑结构将用户读写的逻辑记转换成文件逻辑结构内的相应块号

#### 5. 物理文件系统

把逻辑记录所在的逻辑块号转化为实际的物理块号

#### 6. 辅助分配模块

管理辅存空间，分配、回收辅存空间

#### 7. 设备管理模块

分配和释放设备、设备书写缓冲区，磁盘调度、启动设备、处理设备中断、

![image-20201103130716956](https://gitee.com/happy_every/note_pic/raw/master/image-20201103130716956.png)

### 2. 目录实现

打开文件时，OS利用路径名找到相应目录项

目录的实现就是为了**查找**

#### 2.1 线性列表

使用文件名和数据块指针的线性表

#### 2.2 哈希表

根据文件名通过哈希表得到key值，并返回一个指向线性列表中元素的指针

### 3. 文件实现

类似与内存分页，磁盘中的存储单元也会被划分为一个个的块，很多OS中，磁盘块的大小与内存块、页面的大小相同，方便实现交换

内存与磁盘间的数据交换都是以块为单位

在外存管理中，为了方便实现对文件的数据管理，**文件的逻辑地址空间**也被划分为一个个的**文件块**

文件的逻辑地址也可以表示为(**逻辑块号，块内地址**)，OS为文件分配空间都是**以块为单位**，OS负责实现从逻辑地址到物理地址的映射

#### 3.1 文件分配的方式

##### 1. 连续分配

每个文件在磁盘上占有一组连续的块

文件目录中记录存放的起始块号和长度

![image-20201102191330927](https://gitee.com/happy_every/note_pic/raw/master/image-20201102191330927.png)

物理块号=起始块号+逻辑块号

**连续分配支持随机访问**

读取某个磁盘块时，需要移动磁盘，访问两个磁盘块相隔越远，移动磁头所需时间就越长

**优点**：连续分配在文件的顺序读写时速度最快

**缺点**：**不方便拓展**；存储利用率低，**会产生磁盘碎片**(可以用**紧凑**来处理碎片，但时间代价大)



##### 2. 链接方式(离散分配)

**隐式链接**

目录中记录了文件存放的起始块号和结束块号，每个磁盘块中都会保存一个指向下一个盘块的指针(**链表**！！)

**缺点**：只支持顺序访问，查找效率低，指针会带来少量空间开销

**优点**：方便实现文件拓展，外存利用率高，不会产生碎片



**显式链接**

把用于存放链接文件各物理块指针显式存放在一张表中(**文件分配表FAT**)

目录中只需记录文件的起始块号

![image-20201108155122490](https://gitee.com/happy_every/note_pic/raw/master/image-20201108155122490.png)



<img src="https://gitee.com/happy_every/note_pic/raw/master/image-20201108155136620.png" alt="image-20201108155136620" style="zoom: 33%;" />

**一个磁盘仅设置一张FAT**，开机时，将FAT读入内存，并**常驻内存**，物理块号是隐含的

**优点**：方便实现文件拓展，外存利用率高，不会有外部碎片，**支持随机访问**，地址转化不需要访问磁盘，文件访问效率高

**缺点**：文件分配表FAT需要占用一定的存储空间



##### 3. 索引分配

系统为**每个文件**建立一张**索引表**，索引表中记录了文件的各个逻辑地址对应的物理块(类似与页表)

![image-20201102194407126](https://gitee.com/happy_every/note_pic/raw/master/image-20201102194407126.png)

**索引块**：索引表存放的磁盘块

**数据块**：文件数据存放的磁盘块

目录中记录的是文件的索引块是几号磁盘号

![image-20201102194249886](https://gitee.com/happy_every/note_pic/raw/master/image-20201102194249886.png)

**优点**：



对于索引表项太多，索引块放不下的解决方案

###### 链接方案

如果索引表太大，可以将多个索引表链接起来

![image-20201102194729807](https://gitee.com/happy_every/note_pic/raw/master/image-20201102194729807.png)

**缺点**：若文件很大，索引表就会很长，需要很多个索引表相连，查找效率低，I/O次数多



###### 多层索引

使第一层索引块指向第二层索引块

![image-20201102194920092](https://gitee.com/happy_every/note_pic/raw/master/image-20201102194920092.png)

**优点**：采用K层索引结构，且顶层索引表未调入内存，则访问一个数据块需要K+1次读磁盘操作

**缺点**：即使是小文件也要进行K+1次读磁盘



###### 混合索引

多种索引分配方式的结合，顶级索引表中，既包含**直接地址索引**，又包含**一级地址索引**和**二级地址索引**(类似树形)

![image-20201102195504809](https://gitee.com/happy_every/note_pic/raw/master/image-20201102195504809.png)

FCB中存有指向顶级索引块的指针

![image-20201102200157650](https://gitee.com/happy_every/note_pic/raw/master/image-20201102200157650.png)



#### 3.2 文件存储空间管理

##### 1.存储空间的初始化与划分

将物理磁盘划分为一个个文件卷(逻辑卷、逻辑盘)

将各个文件卷划分为目录区和文件区

<img src="https://gitee.com/happy_every/note_pic/raw/master/image-20201102201304502.png"/>



##### 2.  空间管理

###### 2.1 空闲表法

**适用于连续分配**，系统为所有空闲区建立**一张空闲盘块表**，与内存的动态分配类似

![image-20201102201748897](https://gitee.com/happy_every/note_pic/raw/master/image-20201102201748897.png)

分配磁盘快：可采用**首次适应、最佳适应、最坏适应、邻近适应**算法来分配空间

回收磁盘块：和动态分区分配相似，**回收时注意表项的合并问题**

###### 2.2 空闲链表法

**空闲盘块链**：将磁盘上所有的空闲空间以盘块为单位相连

![image-20201102211309491](https://gitee.com/happy_every/note_pic/raw/master/image-20201102211309491.png)

空间分配：从链头依次选出K个盘块分配

空间回收：回收的盘块挂到链尾，修改链尾指针

适用于离散分配的物理结构，为文件分配多个盘块需要多次操作

**空闲盘区链**：将磁盘上所有的空闲盘区(可能有若干各块)相连

![image-20201102211710996](https://gitee.com/happy_every/note_pic/raw/master/image-20201102211710996.png)

空间分配：可采用首次适应、最佳适应等算法分配空间，若没有合适的连续空闲块，也可以将不同盘区的盘块同时分配给一个文件

空间回收：与某个空闲盘区相连，需要合并；若无，则挂到队尾

**适用于离散、连续分配**，为文件分配多个盘块时效率更高

###### 2.3 位示图法

每位对应一个盘块，**可以用(字号，位号)对应一个盘块号**

![image-20201102212203362](https://gitee.com/happy_every/note_pic/raw/master/image-20201102212203362.png)

**掌握盘块号与(字号，位号)相互转化的公式**

空间分配：顺序扫描位示图，找到K个0；根据字号、位号计算出盘块号并分配给文件；将相应位设为1

空间回收：根据回收的盘块号计算对应的字号、位号，将对应位设为0

适用于连续分配和离散分配

###### 2.4 成组链接法

空闲表、空闲链表法不适用与大型文件，UNIX中采用了**成组链接法**对磁盘空闲块进行管理

文件卷的目录区中专门用一个磁盘块作为**超级块**，系统启动时读入内存，并保持内外存中超级块数据一致

![image-20201102212947888](https://gitee.com/happy_every/note_pic/raw/master/image-20201102212947888.png)

![image-20201102213200044](https://gitee.com/happy_every/note_pic/raw/master/image-20201102213200044.png)

类似与结构体指针

## 4.3 磁盘的组织和实现

#### 1. 磁盘的结构

磁盘的表面由一些磁性物理物质组成，可以用这些磁性物质来记录二进制数据

磁盘的盘面被划分为一个个磁道,一个磁道有被划分为一个个扇区，每个扇区就是一个**磁盘块**，相邻磁盘块有一定间隔，每个扇区固定存储大小(一般为512B)，扇区是磁盘可寻址的**最小存储单位**

由于扇区按圆心角划分，所以**最内侧的扇区密度最大**，磁盘的存储能力受限于**最内道的最大记录密度**

![image-20201103184804887](https://gitee.com/happy_every/note_pic/raw/master/image-20201103184804887.png)

每个磁盘有多个盘片，有的盘片可能对应两个盘面

![image-20201103185811639](https://gitee.com/happy_every/note_pic/raw/master/image-20201103185811639.png)

**磁盘的物理地址**：可用(**柱面号，盘面号，扇区号**)来定位任意一个磁盘块

1. 根据柱面号移动磁臂，让磁盘指向指定柱面
2. 激活指定盘面对应的磁头
3. 磁盘旋转过程中，指定的扇区会从磁头下面划过，完成对指定扇区的读写



**磁盘分类**

- 磁头是否可移动
    - 可以移动的称为**移动头磁盘**
    - 不可移动的称为**固定头磁盘**，每个磁道对应一个磁头
- 盘片是否可更换
    - 可更换的称为**可换盘磁盘**
    - 不可更换的称为**固定盘磁盘**

#### 2. 磁盘调度算法

**寻道时间$T_S$**：在读写前，将磁头移动到指定磁道所花的时间

1. 启动磁头臂，耗时s
2. 移动磁头臂，每跨越一个磁道耗时m，跨越n条磁道
3. **寻到时间$T_S=s+m*n$**

**延迟时间$T_R$**：通过旋转磁盘，使磁头定位到目标扇区所需要的时间,设转数为 r (单位：转/秒)

​	**平均延迟时间=$T_R=(1/2)*(1/r)=1/2r$**

**传输时间$T_t$**：从磁盘读出或写入数据所花时间，假设转数r，读写字节数为b，每个磁道字节数为N

​	**传输时间$T_t=(1/r)*(b/N)=b/rN$**

​	

总的平均存取时间$T_a=T_s+1/2r+b/rN$

OS能影响只有寻道时间

##### 2.1 先来先服务FCFS

**算法思想**：根据进程请求访问磁盘的先后顺序进行调度

**优点**：公平，如果请求访问磁道比较集中，性能还行

**缺点**：如果有大量进程竞争使用磁道，请求访问的磁道很分散，FCFS的性能很差，寻道时间长

##### 2.2 最短寻找时间优先SSTF

**算法思想**：优先处理**与当前磁头最近的磁道**，保证当前这次的寻道时间最短，不能保证总的寻道时间最短(**贪心思想**)

**优点**：性能较好，平均寻道时间短

**缺点**：可能产生**饥饿**(磁头可能在小区域内来回移动)

##### 2.3 扫描算法SCAN

**算法思想**：只有磁头移动到最外侧磁道时，才能往内移动，移动到最内侧时才能往外移动，也称**电梯算法**

**优点**：性能较好，平均寻道时间较短，不会产生饥饿

**缺点**：只有达到最边上的磁道才能改变磁头移动方向；SCAN对各位置磁道的响应时间频率不平均

##### 2.4 LOOK调度算法

**算法思想**：如果磁头移动方向上，已经没有别的请求，就可以立即改变磁头移动方向

**优点**：比起SCAN算法，使寻道时间进一步缩短

##### 2.5 循环扫描算法C-SCAN

**算法思想**：磁头移动到最边上的磁道后，直接快速移动到另一段

**优点**：比起SCAN，对于各位置磁道的响应频率很平均

**缺点**：必须移动到最边上的磁道；比起SCAN，平均寻道时间更长

##### 2.6 C-LOOK调度算法

**算法思想**：磁头只需移动到由磁道访问请求的位置即可，不必移动最边上

**优点**：比起C-SCAN，寻道时间进一步缩短



**减少磁盘延迟时间的方法**

磁盘读入数据后，需要一小段时间进行处理，但是盘片又在不停地旋转，如果逻辑上相邻的扇区在物理上也相邻，则连续读入几个连续的逻辑扇区，可能需要很长的**延迟时间**

**1. 交替编号**

**让逻辑相邻的扇区在物理上有一定间隔**，可以使连续的逻辑扇区所需要的延迟时间更小

**2. 错位命名**

**相邻盘面的扇区编号错开**，磁头读取一个扇区需要转两圈

![image-20201103222912848](https://gitee.com/happy_every/note_pic/raw/master/image-20201103222912848.png)

**磁盘地址结构的设计**

读取地址连续的磁盘块时，采用(柱面号，盘面号，扇区号)的地址结构可以减少磁头移动消耗的时间



#### 3. 磁盘的管理

##### 3.1 磁盘初始化

1. 进行低级格式化(物理格式化)，将磁道划分为扇区，一个扇区通常可分为头、数据区域、尾组成，管理扇区所需的数据结构一般存放在头尾两个部分
2. 将磁盘分区，每个分区由若干柱面组成(C、D、E盘)
3. 进行逻辑格式化，创建文件系统

**物理格式化**：为每个磁盘的每个扇区采用特殊的数据结构，将磁道划分为扇区

**逻辑格式化**：OS将初始的文件系统数据结构存储到磁盘，这些数据结构包括空闲和已分配的空间及一个初始为空的目录

##### 3.2 引导块

计算机开机时，运行自举程序，完成初始化

ROM中只存放很小的**自举装入程序**，完整的自举程序放在磁盘的启动块(引导块/启动分区)位于磁盘的固定位置

##### 3.3 坏块的管理

坏的扇区就是**坏块**，属于硬件故障，是OS无法修复的

对于简单磁盘，可在FAT表上标明坏扇区，**坏块对OS不透明**



对于复杂的磁盘，磁盘控制器维护一个坏块表，磁盘中会保留一些**备用扇区**，用于替换坏块，坏块对OS透明