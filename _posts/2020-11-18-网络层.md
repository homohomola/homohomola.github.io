---
layout:     post
title:      网路层
subtitle:   TCP/IP第3层
date:       2020-11-18
author:     sakura
header-img: img/the-first.png
catalog: true
tags:
    - 计算机网络
---

# 4 网络层

## 4.1 网络层概述

实现网络互连，实现数据报在各网络之间传输（**主机到主机**通信）

- 向运输层提供服务类型
- 网络层寻址问题
- 路由选择问题



面向连接的虚电路VC

- 可靠通信由网络来保证
- 必须建立网络层连接
- 通信双方沿着已建立的虚电路发送分组
- 目的主机地址仅在建立阶段使用，之后**每个分组首部只需携带一条虚电路编号**（构成虚电路的每段链路都有一个虚电路编号
- 通信结束、释放虚电路

## 4.2 IPv4地址

IPv4就是互联网上每台主机的每一个接口分配一个唯一的32比特的标识符

IPv4采用**点分十进制**表示方法

### 4.2.1 IPv4数据报首部格式

![image-20201011131454677](https://gitee.com/happy_every/note_pic/raw/master/image-20201011131454677.png)

- 版本
    - 占4位，表示IP协议的版本；通信双方的版本号必须一致
- 首部长度
    - 占4位，表示IP数据报首部长度，取值以4字节为单位，最小取值为5，表示只有20字节的固定部分；最大为15
- 可选字段
    - 用来支持排错、测量及安全等措施(实际上很少用)
- 填充字段
    - 确保首部长度为4字节的整数倍，全0填充
- 总长度
    - 表示是IP数据报的总长度
- 标识
    - 属于同一数据报的各分片应具有相同标识
- 标志
    - 占3位
    - DF位：1表示不允许分片
    - MF位：1表示后面还有分片
    - 保留位：必须为0
- **片偏移**
    - **偏移量必须位整数**
    - 占13位，指出分片数据载荷部分偏移其在原数据报的位置有多少个单位，以8字节为单位
- 生存时间TTL（解决网络环路）
    - 占8位，**最初**以秒为单位，最大生存周期位255秒；路由器转发时将TTL减去在本路由所耗费的时间，不为0则转发，否则丢弃
    - 现在以**跳数**为单位，每次减一
- 协议字段
    - 指明数据部分是何种协议数据单元PDU
- 首部检验和
    - 占16位，**检测首部**是否出错。比CRC简单

### 4.2.2 分类编制的IPv4

主机号全0为网络地址，全1为广播地址

#### 1. A类地址

![image-20201010164333757](https://gitee.com/happy_every/note_pic/raw/master/image-20201010164333757.png)

第一个可指派网络为1，网络地址为1.0.0.0

**最大网络号为127，作为本地回环测试地址，不指派**(仅A类有本地回环测试)

可指派A类网络数量为126，可分配IP地址为$2^{24}-2$

#### 2. B类地址

![image-20201010164700129](https://gitee.com/happy_every/note_pic/raw/master/image-20201010164700129.png)

最小网络号为`128.0`

最大网络号为`191.255`

可指派B类网络数量为`$2^{16-2}=2^{14}$`

每个网络可分配 IP地址为 `$2^{16}-2$`

#### 3. C类地址

![image-20201010164952975](https://gitee.com/happy_every/note_pic/raw/master/image-20201010164952975.png)

最小网络号`192.0.0`

最大网络号`223.255.255`

可指派网络号数量`$2^{24}-3=2^{21}$`

每个网络可分配IP地址为  `$2^{8}-2$`

**D类地址**

`1110~~`

多播地址，无主机号

**E类地址**

`1111~`

保留为今后使用

| 网络号 | 主机号     | 源地址 | 目的地址 | 含义                         |
| :----: | ---------- | ------ | -------- | ---------------------------- |
|   0    | 0          | 可以   | 不可     | 在本网络的本主机             |
|   0    | host-id    | 可以   | 不可     | 本网络的某台host-id          |
|  全1   | 全1        | 不可   | 可以     | 只在本网络进行广播           |
| net-id | 全1        | 不可   | 可以     | 对net-id上的所有主机进行广播 |
|  127   | 非全0或全1 | 可以   | 可以     | 用于本地环回测试             |

### 4.2.3 划分子网的IPv4

**从主机号部分借用一部分来作为子网号**（减少A,B类网络消耗）

子网验码可以表明分类IP地址的主机号部分被借用了几位作为子网号

**IPv4：**

![image-20201010191106270](https://gitee.com/happy_every/note_pic/raw/master/image-20201010191106270.png)

**子网掩码：**

![image-20201010191122546](https://gitee.com/happy_every/note_pic/raw/master/image-20201010191122546.png)

将IPv4与子网掩码做逻辑与运算，就可得到子网的网络地址

**默认子网掩码**

- A类：`255.0.0.0`
- B类：`255.255.0.0`
- C类：`255.255.255.0`

### 4.2.4 无分类编址的IPv4

**无分类域间路由选择CIDR**(Classless Inter-Domain Routing)

why：数量巨大的C类地址没有得到充分使用（地址空间小）

CIDR使用斜线记法，在IPv4后面加 `/`，在斜线后面写上网络地址所占的位数。

![image-20201010194049527](https://gitee.com/happy_every/note_pic/raw/master/image-20201010194049527.png)

**路由聚合**(构造超网)

- 目的：减少路由表记录
- 方法：使用CIDR，找到**共同前缀**，得到聚合地址块
- 网络前缀越长，地址块越小，路由越具体；在路由查表转发时，会选择前缀最长的那条( 如有多条)，这称为**最长前缀匹配**

### 4.2.5 地址应用规划

#### 1. 定长的子网掩码FLSM

(Fixed Length Subnet Mask)

使用同一个子网掩码来划分子网，每个子网IP地址数相同，会造成IP地址浪费

#### 2. 变长的子网掩码VLSM

(Variable Length Subnet Mask)

对每个网络分配不同的地址掩码

### 4.2.6 IP数据报的发送和转发

同一网络内主机通信属于直接交付；不同属于间接交付

主机发送数据到不同网络需要指定默认路由器(默认网关)

路由器不会转发广播数据报

**主机的默认网关应配置成路由器的IP地址**

## 4.4 路由协议

### 4.4.1 静态路由配置

- 用户或网络管理员使用路由器相关命令给路由器**人工配置路由表**
    - 方式简单、开销小、不能及时适应网络变化
    - 只用在小规模网络
- 存在问题
    - 配置错误
    - 聚会不存在的网络
    - 网络故障

默认路由(目的网络为`0.0.0.0`，地址掩码为`0.0.0.0`)

特定主机路由(目的网络为特定主机IP地址，地址掩码为`255.255.255.255`)

**配置错误导致路由环路**

解决方法：在IP数据报首部设置生存时间TTL字段，每次进入路由-1，若等于0，则丢弃

**聚合不存在网路**

使用聚合路由时，会导致加入了不存在的路由，接收到IP数据报的路由器会通过默认路由转发，可能导致产生路由环路

解决方案：添加黑洞路由，丢弃数据报

**网络故障**

网络生故障，接收路由表中记录被删除，通过默认路由转发，可能导致环路。

解决方案：添加黑洞路由

### 4.4.2 动态路由选择

**特点**

- 自适应    动态路由选择，适应网络变化
- 分布式    路由器之间交换路由信息
- 分层次    将互联网划分为许多较小的自治系统AS(Autonomous System)

**层级路由**

- 自治系统AS
    - 外部网关协议EGP
        - 边界网关协议BGP
    - 内部网络网关协议IGP
        - **路由信息协议 RIP**--基于距离向量
        - **开放式最短路径优先OSPF**--基于链路状态
        - 中间系统到中间系统IS-IS--ISP骨干网上的IGP协议

**路由器基本结构**

- 路由选择部分
    - 路由选择处理机，根据所使用的路由选择协议，周期性更新路由表，并发送自己所知道的路由信息给其他路由表
- 分组转发部分
    - 输入端口
    - 交换结构
        - 进行分组处理
        - 包含转发表(由路由表得出)
    - 输出端口



### 4.4.3 距离-向量路由协议

RIP分装到UDP协议端口号520

路由信息协议RIP要求自治系统AS的每个路由维护自己到AS内每一个网络的距离记录(距离向量D-V)

RIP使用跳数(Hop Count)作为度量(Metric)来**衡量到达目的网络的距离**

- 路由器到直连网络距离为 经过路由器数 + 1
- 距离等于16(15个路由器)时，为不可达。只适用于小型网



RIP认为好的路由就是经过路由器数量最少的路由

当到达同一网络有多条“距离相等”的路由时，可以进行**等价负载均衡**

RIP三大要点

- 仅和相邻路由器交换信息
- 交换自己的路由表
- 周期性交换信息

**更新路由表规则**

- 发送新网络，添加

- 不同下一跳，新路由优势——更新
- 不同下一跳，等价负载均衡
- 相同下一跳，更新
- 不同下一跳，劣势——不更新

**路由环路问题**

- 距离向量算法固有问题
- 问题来源
    - 坏消息传得慢
    - 当链路故障时，离得近的路由将距离增大到16(表示不可达)
    - 离得远的路由发送自身路由信息，误导离得近的路由器
    - 两个路由器反复传递错误的路由信息，每次距离加一，直到距离为16(发现错误)--收敛
- 采取措施
    - 限制最大路径距离为15(16表示不可达)
    - 当路由表更新就立即发送更新报文
    - 让路由表记录收到特定路由信息的接口

### 4.4.4 链路状态路由协议

开放最短路劲优先OSPF(Open Shortest Path First)

- 基于链路状态
    - 指本路由与哪些路由相邻，以及相应链路代价
    - 代价表示费用、距离、时延、带宽等等，网管决定
- 使用最短路径算法SPF，不会产生路由环路
- 不限制网络规模，更新效率高，收敛速度快



#### **1. 工作原理**

OSPF相邻路由器间通过交互**问候(Hello)分组**，建立和维护**邻居关系**

- Hello分组分装在IP数据报中，发往组播地址`224.0.0.5`

![image-20201011102321067](https://gitee.com/happy_every/note_pic/raw/master/image-20201011102321067.png)

- 发送周期为10秒
- 40秒未收到邻居的Hello分组，则认为该路由器不可达



- 使用OSPF的每个路由器都会产生**链路状态通告LSA(Link State Advertisement)
    - 直连网络的链路状态
    - 邻居路由器的链路状态信息

- LSA被封装在链路状态更新分组LSU中，采用洪泛法发送，使得LSDB达到一致
- 每个使用OSPF的路由器都有**链路状态数据库LSDB**，用于存储LSA

- 使用OSPF的路由器**基于LSDB进行最短路径优先SPF计算，构建出各自到达其他路由器的最短路径(自身的路由表)



#### **2. OSPF分组类型**

- **问候**(Hello)
    - 用于发现和维护邻居路由器的可达性
- **数据库描述**(Database Description)
    - 向邻居路由器给出自己LSDB的所有链路状态的摘要信息
- **链路状态请求**(Link State Request)
    - 向邻居路由器请求发送某些链路状态的详细信息
- **链路状态更新**(Link State Update)
    - 使用这种分组将其链路状态进行洪泛发送，对全网更新链路状态
- **链路状态确认**(Link State Acknowledgment)
    - 对链路状态更新分组的确认分组

#### **4. OSPF的工作过程**

![image-20201011104909695](https://gitee.com/happy_every/note_pic/raw/master/image-20201011104909695.png)

链路发生变化或30分钟

![image-20201011105006038](https://gitee.com/happy_every/note_pic/raw/master/image-20201011105006038.png)

#### 5. 在多点接入网络中邻居关系的建立

- 选举**指定路由器DR**(Designated Router)和**备用的指定路由器BDR**(Backup Designated Router)
- 所有其他用路由器只与DR/BDR建立邻居关系，通过DR/BDR交换信息
- 邻居关系数量 2*(n-2)+1 ,1为DR与BDR之间关系

#### 6. 层次的实现

OSPF将一个自治系统AS再划分若干个更小的范围，区域(Area)

- 每个区域都有32位的区域标识符，主干区域的标识符必须为0.0.0.0，用于连通其他区域
- 路由器类型
    - 区域内路由器IR(Internal Router)
    - 区域边界路由器ABR(Area border Router)
    - 主干路由器BBR(BackBone Router)
    - 自治系统边界路由器ASBR(AS Border Router)
- 把**利用洪泛法交换链路状态信息的范围局限于每个区域**而不是AS，减少了整个网络的通信量。

### 4.4.5 边界网关协议BGP

- 对于不同自治系统，度量路由的代价不同。因此，对于AS间的路由系统选择代价作为度量来寻找最佳路由是不行的

- AS间的路由选择必须考虑相关策略(政治、经济、安全)
- BGP只能寻找一条比较好的路由，并非最佳



**工作原理**

- 每个AS选择一个路由器作为AS的BGP发言人
- 不同AS的BGP交换路由信息，必须建立TCP连接，端口号位179
    - 在TCP连接上交换BGP报文以建立BGP会话
    - 利用BGP会话**交换路由信息**(网络可达性的信息)
- BGP发言人还要运行自己AS的内部网关协议IGP
- BGP发言人根据所用策略从收到的路由信息找到到达各AS较好的路由，构造树形结构



**BGP-4报文类型**

- OPEN打开报文：与 相邻BGP建立关系，初始化通信
- UPDATA更新报文：通告某一路由信息以及列出要撤出的多条路由
- KEEPALIVE保活报文：周期性证实邻站的连通性
- NOTIFICATION通知报文：发送检测到的差错

## 4.5 网际控制报文协议ICMP

主机或路由器使用ICMP来发送**差错报告报文**和**询问报文**

ICMP被封装在IP数据报中

**差错报告报文**

- 终点不可达
- 源点抑制（由于拥塞而丢弃数据报）
- 时间超过（TTL值为0，向源主机发送报告）
- 参数问题（IP数据报首部检验和字段检验出错，丢弃并向源主机发送报告）
- 改变路由（路由器通知主机有更好的路由路径）

**询问报文**

- 回送请求和回答
    - 主机发送ICMP回送请求报文
    - 收到报文的主机必须发送ICMP回送回答报文
    - 用于测试目的站是否可达，并了解有关状态
- 时间戳请求和回答报文
    - 请求主机回答当前时间
    - 进行时钟同步和测量时间

**ICMP应用**

- 分组网间探测PING(Packet InterNet Groper)
    - 用于测试主机间的连通性
    - 应用层直接使用网际层的ICMP
    - 使用ICMP回送 请求/回答报文
- 跟踪路由(traceroute)
    - 用于测试IP数据报从源主机到达目的主机要经过的路由器
    - 原理：发送生存时间(从1不断+1)的ICMP回送请求报文，依次得到进过路由器的IP地址

## 4.6 虚拟专用网VPN

两个专用网络，各主机分配专用地址(私有地址)

私有地址只有用于内部通信，不能和互联网上主机通信

- `10.0.0.0/8`
- `172.16.0.0/12`

- `129.168.0.0/16`

路由器对目的地址为私有地址的数据报不转发

两个专用网需要一个路由器具有合法全球IP地址

**发送方对内部数据报进行加密**，重新添加首部。

接收到接收到了进行解密，提取内部IP数据报，发送到对应主机

VPN也被称为IP隧道技术

## 4.7 网络地址转换NAT

- 使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上主机，解决IP耗尽问题

路由器安装NAT软件，NAT路由器至少有一个全球地址，私有主机与外界通信时，转化为全球地址

工作流程

- 修改IP数据报的源地址为全球地址(临时分配)
- 记录私有地址和全球地址的对应关系
- 转发IP数据报
- 收到互联网上数据报时，查表修改IP目的地址为私有地址



内网主机不能充当因特网服务器，对于P2P网络应用，需要外网主动与内网通信，在通过NAT时会遇到问题，需要网络应用自己使用一些特殊的NAT穿越技术解决问题

NAT对外网屏蔽了内网主机的IP地址，能为内网主机提供一定安全保护



## 4.8 动态主机配置DHCP

作用：动态给主机分配IP地址

特点：使用UDP协议传输、**应用层协议**

**工作流程**

- 主机向DHCP服务器**广播**发送报文，源地址`0.0.0.0`，目的地址`255.255.255.255`
- DHCP服务器接收报文，在数据库中查找该主机配置信息，如无则从IP池中取出地址分配
- DHCP服务器的回答报文叫作提供报文

**交换过程**(全部都是广播)

- DHCP客户机广播**DHCP发现消息**，客户机地址为`0.0.0.0`
- 服务器接收到发现消息后，**广播**DHCP提供消息，包括客户机的IP地址和配置信息，使用ARP确保IP地址未被其他主机占用
- 客户机接收到提供消息后，接受配置参数，则广播**DHCP请求信息**，向服务器申请IP地址
- DHCP广播**DHCP确认消息**，分配IP地址给该主机
- 客户机还会使用ARP检测分配的IP地址是否已被占用
    - 若被占用，则发送DHCP DECLINE 报文撤销IP地址租约，并重新发送DHCP发现报文

DHCP允许配置多台服务器，DHCP客户机只会挑选一个，通常是**最先到达的消息**



**租用期**

当租用期到一半时，发送DHCP请求报文，请求新的IP地址；若收到DHCP否认报文，则停用得到的IP地址，并发送DHCP发现报文

如无响应且到0.875租用期时，发送DHCP请求报文

若到租用期则停止使用IP地址并重发DHCP发现报文

客户可随时发送DHCP释放报文(源`0.0.0.0`，目的`255.255.255`)，提前终止租用期



**DHCP中继代理**

减少DHCP服务器的数量，因为DHCP发现报文不能通过路由器转发，所以给路由器配置DHCP服务器IP地址，使之成为DHCP中继代理

## 4.9 IPv6

### 4.9.1 特点

首部长度必须为8B的整数倍

简化IP分组的首部，只有8个字段（IPv4 12个）

移除校验字段

IPv6只在本主机处分片（IPv4可以在路由器和主机）

ICMPv6增加报文类型"分组过大"

取消协议字段，改成下一个首部字段

### 4.9.2 格式

- 版本4位
- 通信量类8位
- 流标号20位
- 有效载荷长度16位
- 下一个首部8位
- 跳数限制8位
- 源地址/目的地址 各 128位

IPv4**地址类型**

- 单播
- 组播
- 任播

IP地址采用16进制表示法，4个16进制数以一个：分隔



## 4.10 IP组播

组播用于UDP协议，一对多传播数据

源主机只发送一份数据，由路由器进行复制，只有组内主机才能收到数据

**IP组播地址**

IP使用D类地址支持组播，前缀是 1110，地址范围为`224.0.0.0`-`239.255.255.255`

- 组播地址只能用于目的地址
- 不产生ICMP差错报文
- 并非所有D类地址都可以作为组播地址

IP组播分为两种：本局域网硬件组播；互联网范围内组播



**组播地址和MAC地址换算**

映射IP地址的后24位，映射后第1位取0.转化为16进制数

加上`01-00-5E`，得到MAC地址

**映射地址并不唯一，但概率很小，即使收到另一个的组播数据报，由上层协议判断，丢弃分组**



## 4.11 移动IP

特点：接入点不断变化

**需要的功能实体**

- 移动结点：具有永久IP的移动结点
- 本地代理：由一个端口与移动结点本地链路相连的路由器，根据移动用户的转交地址，采用隧道技术转交移动结点的数据报
- 外部代理：移动结点漫游链路上的路由器，通知本地用户代理自己的转交地址

**需要的技术**

- 代理搜索：计算机要知道自己是否在漫游
- 申请转交地址：在外地时只有临时地址，需要有一个固定地址来进行转交数据报
- 登入：移动结点到达外网时进行一系列认证、注册、建立隧道的过程
- 隧道：本地代理与外部代理之间临时建立的双向数据通道

**工作原理**

​	移动IP为主机设置两个IP地址，主地址和转交地址。当移动到另一个网络时，获得一个临时的辅助地址，进行转交。